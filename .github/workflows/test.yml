name: CI
on: [push, pull_request]
jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        nim-version: ['1.4.2', '1.4.x', '1.6.0', '1.6.x', '2.0.0', 'stable', 'devel']

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v3

    - uses: jiro4989/setup-nim-action@v1
      with:
        nim-version: ${{ matrix.nim-version }}
        repo-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Run tests with balls
      if: ${{ matrix.os == 'ubuntu-latest' && (matrix.nim-version == 'stable' || matrix.nim-version == 'devel') }}
      run: |
        nimble install -y https://github.com/disruptek/balls
        balls -b:c -d:debug -d:release -d:danger --mm:arc --mm:orc -d:staticSqlite

    - name: Run tests with balls@v3
      if: ${{ !(matrix.os == 'ubuntu-latest' && (matrix.nim-version == 'stable' || matrix.nim-version == 'devel')) && matrix.nim-version != '1.4.2' && matrix.nim-version != '1.4.x' && matrix.nim-version != '1.6.0' }}
      run: |
        nimble install -y https://github.com/disruptek/balls@#v3
        balls -b:c -d:debug -d:release -d:danger --mm:arc --mm:orc -d:staticSqlite

    - name: Run tests with nimble test
      if: ${{ matrix.nim-version == '1.4.2' || matrix.nim-version == '1.4.x' || matrix.nim-version == '1.6.0' }}
      shell: bash
      run: |
        nimble test -y --gc:arc -d:staticSqlite & a=$1
        nimble test -y --gc:orc -d:staticSqlite & b=$!
        nimble test -y -d:release --gc:arc -d:staticSqlite & c=$!
        nimble test -y -d:release --gc:orc -d:staticSqlite & d=$!
        nimble test -y -d:danger --gc:arc -d:staticSqlite & e=$!
        nimble test -y -d:danger --gc:orc -d:staticSqlite & f=$!
        for pid in $a $b $c $d $e $f; do
          wait $pid || FAIL=$?
        done
        [ -z $FAIL ] || exit $FAIL
